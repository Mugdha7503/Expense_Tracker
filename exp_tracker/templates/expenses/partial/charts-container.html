{% load widget_tweaks %}


<div class="flex flex-col-reverse md:grid md:grid-cols-4 md:gap-4" id="charts-container">
  
  <!-- ✅ Chart Section (wrapped inside #charts-content) -->
  <div class="col-span-3 space-y-6" id="charts-content">
    <!-- Pie Chart -->
    <div class="bg-gray-900 p-4 rounded-lg shadow h-64">
      <h2 class="text-white mb-2 text-lg font-semibold">Expenses by Category (Current Month)</h2>
      <canvas id="categoryPieChart" class="w-full h-full"></canvas>
    </div>

    <!-- Line Chart -->
    <div class="bg-gray-900 p-4 rounded-lg shadow h-72">
      <h2 class="text-white mb-2 text-lg font-semibold">Expenses Over Time</h2>
      <canvas id="expenseLineChart" class="w-full h-full"></canvas>
    </div>
  </div>

  <!-- Filter Form -->
  <div class="col-span-1">
   
    <form hx-get="{% url 'transactions-charts' %}" hx-target="#charts-container" hx-swap="outerHTML" hx-push-url="true">
      <div class="mb-4 form-control">
        {{ filter.form.transaction_type|add_label_class:"label text-white" }}
        {% render_field filter.form.transaction_type class="select bg-gray-50 text-gray-900 w-full max-w-xs" %}
      </div>

      <div class="mb-2 form-control">
        {{ filter.form.start_date|add_label_class:"label text-white" }}
        {% render_field filter.form.start_date class="input bg-gray-50 text-gray-900" %}
      </div>

      <div class="mb-2 form-control">
        {{ filter.form.end_date|add_label_class:"label text-white" }}
        {% render_field filter.form.end_date class="input bg-gray-50 text-gray-900" %}
      </div>

      <div class="mb-4 form-control">
        {% render_field filter.form.category class="text-green-500 border-gray-300 rounded focus:ring-green-500" %}
      </div>

      <button class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded shadow" type="submit">
        Filter
      </button>
    </form>
  </div>
</div>
<script>
(function () {
  // Ensure Chart.js is available
  if (typeof Chart === 'undefined') {
    console.error('Chart.js not loaded — make sure <script src="...chart.js..."> is included in base template.');
    return;
  }

  // Render the Django lists as JS arrays directly.
  // Using |default:"[]" and |safe outputs valid JS array literals from Python lists.
  const pieLabels = {{ pie_labels|default:"[]"|safe }};
  const pieValues = {{ pie_values|default:"[]"|safe }};
  const lineLabels = {{ line_labels|default:"[]"|safe }};
  const lineValues = {{ line_values|default:"[]"|safe }};

  // Debugging (optional): uncomment to log values
  // console.log('pieLabels', pieLabels, 'pieValues', pieValues, 'lineLabels', lineLabels, 'lineValues', lineValues);

  // Destroy previous instances if they exist (prevents overlaying charts)
  if (window.categoryPieChartInstance) {
    try { window.categoryPieChartInstance.destroy(); } catch (e) { /* ignore */ }
    window.categoryPieChartInstance = null;
  }
  if (window.expenseLineChartInstance) {
    try { window.expenseLineChartInstance.destroy(); } catch (e) { /* ignore */ }
    window.expenseLineChartInstance = null;
  }

  // Guard: if no canvas elements present, abort
  const pieCanvas = document.getElementById('categoryPieChart');
  const lineCanvas = document.getElementById('expenseLineChart');
  if (!pieCanvas || !lineCanvas) {
    console.warn('Chart canvas elements not found in DOM.');
    return;
  }

  // Create Pie chart
  try {
    const ctxPie = pieCanvas.getContext('2d');
    window.categoryPieChartInstance = new Chart(ctxPie, {
      type: 'pie',
      data: {
        labels: pieLabels,
        datasets: [{
          data: pieValues,
          // You can expand this color list to match number of categories
          backgroundColor: [
            '#4ADE80', '#60A5FA', '#FBBF24', '#F87171', '#A78BFA', '#F472B6',
            '#34D399', '#60A5FA', '#F97316'
          ],
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });
  } catch (err) {
    console.error('Error creating pie chart', err);
  }

  // Create Line chart
  try {
    const ctxLine = lineCanvas.getContext('2d');
    window.expenseLineChartInstance = new Chart(ctxLine, {
      type: 'line',
      data: {
        labels: lineLabels,
        datasets: [{
          label: 'Total',
          data: lineValues,
          borderColor: '#4ADE80',
          tension: 0.3,
          fill: true,
          backgroundColor: 'rgba(74, 222, 128, 0.12)',
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: { display: true },
          y: { beginAtZero: true }
        }
      }
    });
  } catch (err) {
    console.error('Error creating line chart', err);
  }
})();
</script>
